<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module Chi Hộ - VTC Pay</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts: Open Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --vtc-blue: #0068ac;
            --vtc-blue-dark: #005691;
            --header-bg: #f8f9fa;
            --table-header-bg: #e9ecef;
        }

        body {
            font-family: "Helvetica Neue", Helvetica, Arial, "Open Sans", sans-serif;
            background-color: #fff;
            font-size: 13px;
        }

        /* --- Common Styles --- */
        .top-nav {
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            padding: 10px 15px;
            color: #333;
            position: relative;
            z-index: 1000;
        }

        .logo-text {
            font-weight: 800;
            font-size: 24px;
            color: var(--vtc-blue);
            font-style: italic;
            text-decoration: none;
            white-space: nowrap;
        }
        
        .nav-btn {
            background-color: var(--vtc-blue);
            color: white;
            border: none;
            border-radius: 3px;
            padding: 6px 12px;
            margin: 2px;
            font-size: 13px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            text-decoration: none;
        }
        
        .nav-btn:hover {
            background-color: var(--vtc-blue-dark);
            color: white;
        }

        .nav-btn.active-tab {
            background-color: var(--vtc-blue-dark);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .user-info {
            color: var(--vtc-blue);
            font-weight: 500;
            white-space: nowrap;
        }
        
        .page-title-bar {
            background-color: #337ab7;
            color: white;
            padding: 10px 15px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 20px;
            border-left: 5px solid #1b5480;
            font-size: 14px;
        }

        /* Updated Table Container */
        .table-responsive-custom {
            padding: 0;
            margin-bottom: 20px;
            width: 100%;
        }

        /* Updated Table for Fixed Layout & Full Width Display without Scroll */
        .table {
            font-size: 11px; /* Smaller font to fit many columns */
            margin-bottom: 0;
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            table-layout: fixed; /* Bắt buộc để chia tỷ lệ cột chính xác và giữ nguyên trong khung */
        }

        .table th, .table td {
            vertical-align: middle !important; /* Center vertically */
            text-align: center; /* Center horizontally by default */
            padding: 6px 4px;
            border-bottom: 1px solid #dee2e6;
            white-space: normal; /* Allow text wrapping */
            word-wrap: break-word;
            word-break: break-word;
        }

        .table thead th {
            background-color: #dff0d8;
            vertical-align: middle;
            text-align: center;
            border-bottom: 2px solid #aeccae;
            border-top: 1px solid #dee2e6;
            color: #333;
            font-weight: bold;
            padding: 8px 4px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* Column Specifics */
        .col-action { 
            text-align: center; 
            white-space: normal !important; /* Allow wrapping for buttons */
        }
        .col-money { 
            text-align: right !important; /* Override center for money */
            font-weight: bold; 
            color: var(--vtc-blue); 
            padding-right: 8px !important;
        }
        .col-status { text-align: center; }
        .col-id { font-weight: bold; color: #555; }
        .col-date { white-space: normal; }

        .chi-ho-tabs .nav-link {
            color: #555;
            font-weight: 600;
            border-radius: 0;
            margin-bottom: -1px;
        }
        .chi-ho-tabs .nav-link.active {
            color: var(--vtc-blue);
            border-color: #dee2e6 #dee2e6 #fff;
            border-top: 3px solid var(--vtc-blue);
        }
        
        .money-in-words {
            font-style: italic;
            color: #666;
            margin-top: 5px;
            font-size: 12px;
        }

        .recipient-name-display {
            background-color: #e8f4fd;
            border: 1px solid #b6d4fe;
            color: #005691;
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: bold;
            margin-top: 5px;
            display: none;
        }
        
        .is-valid-check {
            border-color: #198754;
            padding-right: calc(1.5em + .75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(.375em + .1875rem) center;
            background-size: calc(.75em + .375rem) calc(.75em + .375rem);
        }

        .d-none-custom { display: none !important; }
        .bg-readonly { background-color: #f8f9fa; }
        
        /* Button Styles */
        .btn-search {
            background-color: #26b6d4; color: white; border: none; padding: 6px 20px; border-radius: 3px; font-weight: bold; transition: background 0.2s;
        }
        .btn-search:hover { background-color: #1a9cb7; color: white; }

        /* Status Badges */
        .badge-pending-approval { background-color: #ffc107; color: #000; } /* Chờ duyệt */
        .badge-created { background-color: #17a2b8; color: #fff; } /* Khởi tạo */
        .badge-success { background-color: #28a745; color: #fff; } /* Thành công */
        .badge-cancelled { background-color: #6c757d; color: #fff; } /* Đã hủy */
        .badge-refunded { background-color: #dc3545; color: #fff; } /* Hoàn tiền */

    </style>
</head>
<body>

    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center top-nav">
        <div class="d-flex align-items-center flex-wrap w-100 overflow-hidden" style="overflow: visible !important;">
            <a href="#" class="logo-text me-3 flex-shrink-0">
                <i class="fa-solid fa-wifi fa-rotate-90 me-1" style="font-size: 18px;"></i>VTC<span style="color: #00a0e3">Pay</span>
            </a>
            
            <!-- Navigation Menu -->
            <div class="ms-md-3 nav-menu-container d-flex align-items-center">
                <a href="#" class="nav-btn me-1 text-decoration-none">
                    <i class="fa-solid fa-arrow-left me-2"></i> Về trang chủ
                </a>
                <button id="nav-chiho" class="nav-btn active-tab me-1">
                    <i class="fa-solid fa-paper-plane me-2"></i> Chi hộ
                </button>
            </div>
        </div>
        
        <div class="d-flex align-items-center user-info-container ms-3">
            <span class="user-info me-2"><i class="fa-solid fa-circle-user me-1"></i> hongtt</span>
            <a href="#" class="text-danger"><i class="fa-solid fa-right-from-bracket"></i></a>
        </div>
    </div>

    <!-- MODULE CHI HỘ CONTENT -->
    <div id="module-chiho" class="module-section">
        <div class="page-title-bar">
            <i class="fa-solid fa-paper-plane me-2"></i> Quản lý Chi hộ / Chuyển tiền
        </div>

        <div class="container-fluid">
            <!-- Sub-Tabs -->
            <ul class="nav nav-tabs chi-ho-tabs mb-3" id="chiHoTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="single-transfer-tab" data-bs-toggle="tab" data-bs-target="#single-transfer" type="button" role="tab">
                        <i class="fa-solid fa-file-pen me-2"></i>Tạo yêu cầu chi hộ
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="approval-transfer-tab" data-bs-toggle="tab" data-bs-target="#approval-transfer" type="button" role="tab">
                        <i class="fa-solid fa-check-to-slot me-2"></i>Duyệt tiền chi hộ
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="chiHoTabContent">
                
                <!-- 1. TẠO YÊU CẦU CHI HỘ (Đổi tên từ Chuyển tiền đơn) -->
                <div class="tab-pane fade show active" id="single-transfer" role="tabpanel">
                    <div class="card shadow-sm border-0">
                        <div class="card-body">
                            <h5 class="card-title text-primary mb-4 border-bottom pb-2">Thông tin yêu cầu</h5>
                            <div id="singleTransferAlert" class="alert alert-danger d-none-custom mb-3" role="alert">
                                <i class="fa-solid fa-circle-exclamation me-2"></i> <span id="singleTransferAlertMsg">Giao dịch không thành công!</span>
                            </div>

                            <form id="formSingleTransfer" onsubmit="handleSingleTransfer(event)">
                                <div class="row g-3">
                                    
                                    <div class="col-12 mb-2">
                                        <h6 class="fw-bold text-uppercase text-secondary"><i class="fa-solid fa-user-tag me-2"></i>Thông tin người nhận</h6>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Số Tài khoản Merchant <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="text" id="merchantAccount" class="form-control" list="merchantListOptions" placeholder="Nhập hoặc chọn số TK Merchant..." required oninput="handleMerchantInput(this)">
                                            <datalist id="merchantListOptions">
                                                <!-- Javascript will populate this -->
                                            </datalist>
                                            <button class="btn btn-primary" type="button" id="btnCheckMerchant" onclick="checkMerchant()" title="Tìm kiếm thông tin">
                                                <i class="fa-solid fa-magnifying-glass"></i>
                                            </button>
                                        </div>
                                        <div class="recipient-name-display mt-2" id="merchantResultContainer">
                                            <i class="fa-solid fa-check-circle me-2"></i>Merchant: <span id="merchantNameDisplay" class="fw-bold text-uppercase"></span>
                                        </div>
                                        <input type="hidden" id="isValidMerchant" value="false">
                                    </div>

                                    <div class="col-md-6">
                                        <!-- Placeholder to align layout -->
                                    </div>

                                    <!-- NEW: Bank Selection & Account Input -->
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Ngân hàng thụ hưởng <span class="text-danger">*</span></label>
                                        <input class="form-control" list="bankListOptions" id="destBankInput" placeholder="Nhập tên ngân hàng để tìm..." required onchange="resetBenName()">
                                        <datalist id="bankListOptions">
                                            <option value="Vietcombank - TMCP Ngoại thương VN">
                                            <option value="VietinBank - TMCP Công Thương VN">
                                            <option value="BIDV - TMCP Đầu tư & PT VN">
                                            <option value="Agribank - NN & PT Nông thôn VN">
                                            <option value="MBBank - TMCP Quân đội">
                                            <option value="Techcombank - TMCP Kỹ Thương VN">
                                            <option value="ACB - TMCP Á Châu">
                                            <option value="VPBank - TMCP VN Thịnh Vượng">
                                            <option value="Sacombank - TMCP Sài Gòn Thương Tín">
                                        </datalist>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Số tài khoản/Thẻ thụ hưởng <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="text" id="destAccountInput" class="form-control" placeholder="Nhập số tài khoản/thẻ..." required onblur="lookupBeneficiaryName()">
                                            <span class="input-group-text bg-light"><i class="fa-regular fa-credit-card"></i></span>
                                        </div>
                                        <div id="benNameLoader" class="text-muted small mt-1 d-none-custom"><i class="fa-solid fa-spinner fa-spin"></i> Đang tra cứu tên...</div>
                                    </div>

                                    <!-- Auto-populated Beneficiary Name -->
                                    <div class="col-12" id="benNameContainer">
                                        <label class="form-label fw-bold text-muted">Tên người thụ hưởng</label>
                                        <input type="text" id="benNameDisplay" class="form-control bg-readonly fw-bold text-primary" readonly placeholder="Tên người nhận sẽ hiện sau khi nhập số tài khoản...">
                                    </div>

                                    <div class="col-12"><hr class="my-2 text-muted"></div>

                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Số tiền (VNĐ) <span class="text-danger">*</span></label>
                                        <input type="text" id="singleAmount" class="form-control" placeholder="Nhập số tiền" required oninput="formatCurrencyInput(this)">
                                        <div id="amountInWords" class="money-in-words"></div>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Nội dung chuyển tiền <span class="text-danger">*</span></label>
                                        <select class="form-select mb-2" id="transferReason" onchange="checkCustomReason()" required>
                                            <option value="">-- Chọn lý do --</option>
                                            <option value="Thanh toán tiền hàng">Thanh toán tiền hàng</option>
                                            <option value="Thanh toán phí dịch vụ">Thanh toán phí dịch vụ</option>
                                            <option value="Hoàn tiền giao dịch">Hoàn tiền giao dịch</option>
                                            <option value="Chi trả lương">Chi trả lương</option>
                                            <option value="OTHER">Khác (Nhập nội dung)</option>
                                        </select>
                                        <textarea id="customReasonArea" class="form-control d-none-custom" rows="2" placeholder="Nhập nội dung khác..."></textarea>
                                    </div>

                                    <div class="col-12 text-end mt-4">
                                        <button type="reset" class="btn btn-secondary me-2" onclick="resetTab1()"><i class="fa-solid fa-rotate-left"></i> Nhập lại</button>
                                        <button type="submit" class="btn btn-primary px-4"><i class="fa-solid fa-plus"></i> Tạo yêu cầu</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- 2. DUYỆT TIỀN CHI HỘ (Đổi tên và thiết kế lại hoàn toàn) -->
                <div class="tab-pane fade" id="approval-transfer" role="tabpanel">
                    
                    <!-- Filter Section UPDATED: Max 2 cols per row, DateTime Inputs -->
                    <div class="filter-section border rounded py-3 mb-3 bg-light">
                        <div class="container-fluid">
                            <div class="row g-2">
                                <!-- Row 1 -->
                                <div class="col-md-6">
                                    <label class="fw-bold mb-1 small">Từ ngày</label>
                                    <input type="datetime-local" id="filterFromDate" class="form-control form-control-sm" step="1">
                                </div>
                                <div class="col-md-6">
                                    <label class="fw-bold mb-1 small">Đến ngày</label>
                                    <input type="datetime-local" id="filterToDate" class="form-control form-control-sm" step="1">
                                </div>
                                
                                <!-- Row 2 -->
                                <div class="col-md-6">
                                    <label class="fw-bold mb-1 small">Trạng thái</label>
                                    <!-- REMOVED 'selected' from PENDING to show all by default -->
                                    <select id="filterStatus" class="form-select form-select-sm">
                                        <option value="" selected>Tất cả</option>
                                        <option value="CREATED">Khởi tạo</option>
                                        <option value="PENDING">Chờ duyệt</option>
                                        <option value="SUCCESS">Thành công</option>
                                        <option value="CANCELLED">Đã hủy</option>
                                        <option value="REFUNDED">Hoàn tiền</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="fw-bold mb-1 small">Số TK Merchant (Tên TK)</label>
                                    <input type="text" id="filterMerAcc" class="form-control form-control-sm" placeholder="Nhập Tên TK (VD: NNVTC...)">
                                </div>
                                
                                <!-- Row 3 -->
                                <div class="col-md-6">
                                    <label class="fw-bold mb-1 small">Tài khoản ngân hàng</label>
                                    <input type="text" id="filterBankAcc" class="form-control form-control-sm" placeholder="Nhập số TK/Thẻ">
                                </div>
                                <div class="col-md-6">
                                    <label class="fw-bold mb-1 small">NH thụ hưởng</label>
                                    <input class="form-control form-control-sm" list="bankListOptions" id="filterDestBank" placeholder="Tìm ngân hàng...">
                                </div>
                                
                                <div class="col-12 text-center mt-3">
                                    <button class="btn btn-search text-white px-5" onclick="renderApprovalTable()">
                                        <i class="fa-solid fa-filter me-2"></i> Lọc dữ liệu
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Toolbar Actions -->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <!-- Left Controls -->
                        <div class="d-flex gap-2 align-items-center">
                            <button class="btn btn-success btn-sm" onclick="showAlert('Đang xuất dữ liệu...')">
                                <i class="fa-solid fa-file-excel me-1"></i> Xuất dữ liệu
                            </button>
                            
                            <div class="d-flex align-items-center bg-white border rounded px-2 py-1">
                                <span class="small me-2 text-muted">Hiển thị:</span>
                                <select class="form-select form-select-sm border-0 py-0 ps-0 pe-4 w-auto" style="height: auto;">
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                </select>
                            </div>

                            <div class="dropdown">
                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fa-solid fa-eye me-1"></i> Ẩn/Hiện cột
                                </button>
                                <ul class="dropdown-menu p-2 shadow" style="min-width: 200px; max-height: 300px; overflow-y: auto;">
                                    <li><label class="dropdown-item small"><input type="checkbox" checked> Mã ĐH</label></li>
                                    <li><label class="dropdown-item small"><input type="checkbox" checked> Mã GD</label></li>
                                    <!-- Add more toggles here -->
                                </ul>
                            </div>
                        </div>

                        <!-- Right Search -->
                        <div class="input-group input-group-sm" style="width: 250px;">
                            <span class="input-group-text bg-white"><i class="fa-solid fa-magnifying-glass text-muted"></i></span>
                            <input type="text" class="form-control" placeholder="Tìm kiếm trong bảng..." onkeyup="filterTableLocal(this.value)">
                        </div>
                    </div>

                    <!-- Data Table -->
                    <div class="table-responsive-custom border rounded bg-white">
                        <table class="table table-hover table-bordered mb-0" id="approvalTable">
                            <!-- DEFINED COLUMN WIDTHS VIA COLGROUP -->
                            <colgroup>
                                <col style="width: 6.5%"> <!-- Mã ĐH -->
                                <col style="width: 6.5%"> <!-- Mã GD -->
                                <col style="width: 6.5%"> <!-- Ngân Hàng -->
                                <col style="width: 6.5%"> <!-- Số tiền -->
                                <col style="width: 6.5%"> <!-- Tên TK -->
                                <!-- Removed Time Col -->
                                <col style="width: 6.5%"> <!-- Số TK NH -->
                                <col style="width: 6.5%"> <!-- Tên TK NH -->
                                <col style="width: 11%"> <!-- Nội dung (x2) -->
                                <col style="width: 6.5%"> <!-- TG Gửi YC -->
                                <col style="width: 6.5%"> <!-- TG Cập nhật -->
                                <col style="width: 6.5%"> <!-- Người cập nhật -->
                                <col style="width: 6.5%"> <!-- Trạng thái -->
                                <col style="width: 11%"> <!-- Mô tả (x2) -->
                                <col style="width: 8%"> <!-- Chức năng -->
                            </colgroup>
                            <thead class="bg-light">
                                <tr>
                                    <th>Mã ĐH</th>
                                    <th>Mã GD</th>
                                    <th>Ngân Hàng</th>
                                    <th>Số tiền</th>
                                    <th>Tên TK</th>
                                    <!-- Removed header Time -->
                                    <th>Số TK Ngân Hàng</th>
                                    <th>Tên TK Ngân Hàng</th>
                                    <th>Nội dung</th>
                                    <th>Thời gian gửi yêu cầu</th>
                                    <th>TG Cập nhật</th>
                                    <th>Người cập nhật</th>
                                    <th>Trạng thái</th>
                                    <th>Mô tả</th>
                                    <th>Chức năng</th>
                                </tr>
                            </thead>
                            <tbody id="approvalTableBody">
                                <!-- Data will be populated via JS -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="footer-pagination d-flex justify-content-between align-items-center mt-3">
                        <div class="text-muted small" id="paginationInfo">Hiển thị <span class="fw-bold">1-11</span> trên <span class="fw-bold">11</span> bản ghi</div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item disabled"><a class="page-link" href="#">Trước</a></li>
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                <li class="page-item"><a class="page-link" href="#">Tiếp</a></li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fa-solid fa-circle-question text-primary me-2"></i>Xác nhận</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    Bạn có chắc chắn?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                    <button type="button" class="btn btn-primary" onclick="onConfirmYes()">Đồng ý</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Approval Modal -->
    <div class="modal fade" id="approveModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fa-solid fa-file-invoice-dollar me-2"></i>Phê duyệt yêu cầu chuyển tiền</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-muted">Mã đơn hàng</label>
                            <input type="text" id="modalOrderId" class="form-control form-control-sm bg-light" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-muted">Mã giao dịch</label>
                            <input type="text" id="modalTransId" class="form-control form-control-sm bg-light" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-muted">Ngân hàng thụ hưởng</label>
                            <input type="text" id="modalBankName" class="form-control form-control-sm bg-light" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-muted">Số tiền</label>
                            <input type="text" id="modalAmount" class="form-control form-control-sm bg-light fw-bold text-primary" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-muted">Tên TK Merchant</label>
                            <input type="text" id="modalMerAcc" class="form-control form-control-sm bg-light" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-muted">Số TK Ngân Hàng thụ hưởng</label>
                            <input type="text" id="modalDestAccNo" class="form-control form-control-sm bg-light" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-muted">Tên người thụ hưởng</label>
                            <input type="text" id="modalDestAccName" class="form-control form-control-sm bg-light" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-muted">Thời gian gửi yêu cầu</label>
                            <input type="text" id="modalCreatedTime" class="form-control form-control-sm bg-light" readonly>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold small text-muted">Nội dung</label>
                            <input type="text" id="modalContent" class="form-control form-control-sm bg-light" readonly>
                        </div>
                        
                        <div class="col-12"><hr class="my-1"></div>
                        
                        <div class="col-md-12">
                            <label class="form-label fw-bold text-primary">Kênh kết nối (Nguồn tiền)</label>
                            <select id="modalChannelSelect" class="form-select form-select-sm" onchange="updateApproveSourceAccount()">
                                <option value="">-- Chọn ngân hàng nguồn --</option>
                                <option value="Sacombank">Ngân hàng TMCP Sài Gòn thương tín (Sacombank)</option>
                                <option value="BIDV">Ngân hàng TMCP Đầu tư và Phát triển Việt Nam (BIDV)</option>
                                <option value="MB">Ngân hàng TMCP Quân đội (MB)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-muted">Số tài khoản nguồn</label>
                            <input type="text" id="modalSourceAcc" class="form-control form-control-sm bg-readonly" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-muted">Tên tài khoản nguồn</label>
                            <input type="text" id="modalSourceName" class="form-control form-control-sm bg-readonly fw-bold" readonly>
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label fw-bold">Mô tả / Ghi chú</label>
                            <textarea id="modalNote" class="form-control form-control-sm" rows="2" placeholder="Nhập ghi chú phê duyệt..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="hidden" id="modalTxId">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fa-solid fa-arrow-left me-2"></i>Quay lại</button>
                    <button type="button" class="btn btn-primary" onclick="confirmApprove()"><i class="fa-solid fa-check-double me-2"></i>Duyệt tiền</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- CUSTOM UTILS ---
        function showAlert(message) {
            const container = document.getElementById('toast-container') || createToastContainer();
            const toastHtml = `
                <div class="toast show align-items-center text-white bg-warning border-0 mb-2 shadow" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body text-dark">
                            <i class="fa-solid fa-bell me-2"></i> ${message}
                        </div>
                        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close" onclick="this.closest('.toast').remove()"></button>
                    </div>
                </div>
            `;
            const temp = document.createElement('div');
            temp.innerHTML = toastHtml;
            const toastEl = temp.firstElementChild;
            container.appendChild(toastEl);
            setTimeout(() => toastEl.remove(), 4000);
        }

        function createToastContainer() {
            const div = document.createElement('div');
            div.id = 'toast-container';
            div.className = 'toast-container position-fixed top-0 end-0 p-3';
            div.style.zIndex = '1060';
            document.body.appendChild(div);
            return div;
        }

        let currentConfirmCallback = null;
        function showConfirm(message, callback) {
            document.getElementById('confirmModalBody').innerText = message;
            currentConfirmCallback = callback;
            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            modal.show();
        }

        function onConfirmYes() {
            if (currentConfirmCallback) currentConfirmCallback();
            const modalEl = document.getElementById('confirmModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
        }

        const formatMoney = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);

        // Helper to format Date string to DD/MM/YYYY HH:MM:SS
        function formatDateTime(dateStr) {
            if (!dateStr || dateStr === '-') return '-';
            // Try to parse input date string
            // Assuming input could be DD/MM/YYYY HH:MM or similar
            // For mock data consistency, if it already looks like dd/mm/yyyy, we append seconds if missing
            // This is a simple formatter for the mock data
            if (dateStr.match(/^\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}$/)) {
                return dateStr + ":00";
            }
             if (dateStr.match(/^\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}:\d{2}$/)) {
                return dateStr;
            }
            return dateStr;
        }

        const docSoThanhChu = (function() {
            const t = ["không", "một", "hai", "ba", "bốn", "năm", "sáu", "bảy", "tám", "chín"];
            const donVi = ["", "nghìn", "triệu", "tỷ", "nghìn tỷ", "triệu tỷ"];
            function doc3So(n, docDayDu) {
                let s = "";
                const tram = Math.floor(n / 100);
                const chuc = Math.floor((n % 100) / 10);
                const dv = n % 10;
                if (docDayDu || tram > 0) {
                    s += " " + t[tram] + " trăm";
                    if (chuc === 0 && dv !== 0) s += " linh";
                }
                if (chuc > 1) {
                    s += " " + t[chuc] + " mươi";
                    if (dv === 1) s += " mốt"; else if (dv === 5) s += " lăm"; else if (dv > 0) s += " " + t[dv];
                } else if (chuc === 1) {
                    s += " mười";
                    if (dv === 1) s += " một"; else if (dv === 5) s += " lăm"; else if (dv > 0) s += " " + t[dv];
                } else if (dv > 0) {
                    if (tram > 0 || docDayDu) s += " " + t[dv]; else s += " " + t[dv];
                }
                return s;
            }
            return function(so) {
                if (so === 0) return "Không";
                let s = ""; let i = 0; so = Math.abs(so);
                while (so > 0) {
                    const lop = so % 1000;
                    if (lop > 0) { s = doc3So(lop, so >= 1000 && i > 0) + " " + donVi[i] + s; }
                    i++; so = Math.floor(so / 1000);
                }
                s = s.trim(); return s.charAt(0).toUpperCase() + s.slice(1);
            }
        })();

        // --- MOCK DATA ---
        const mockMerchants = {
            'NNVTC2C2PVOL': { name: 'CTY CP CONG NGHE VOLTALITY' },
            'M123456': { name: 'CÔNG TY CỔ PHẦN THƯƠNG MẠI DỊCH VỤ ABC' },
            'M888888': { name: 'CÔNG TY TNHH MTV VẬN TẢI XYZ' }
        };

        const sourceAccounts = {
            'Sacombank': '020094055033',
            'BIDV': '1207380178',
            'MB': '0000783364175'
        };

        // Dữ liệu cho Tab Duyệt Tiền (Approval)
        let approvalData = [
            { 
                id: 1, 
                orderId: '3509403', 
                transId: '2776248', 
                bankName: 'Vietinbank', 
                amount: 50000000, 
                merAcc: 'NNVTC2C2PVOL', 
                time: '28/01/2026 10:00',
                destAccNo: '1122334455', 
                destAccName: 'NGUYEN VAN A',
                content: 'Chuyển tiền TRẠM SẠC HAI BÀ TRƯNG', 
                createdTime: '28/01/2026 09:55', 
                updatedTime: '-', 
                user: '-', 
                status: 'PENDING', 
                note: 'Đã gửi yêu cầu' 
            },
            { 
                id: 2, 
                orderId: '3509404', 
                transId: '2776249', 
                bankName: 'Vietcombank', 
                amount: 25000000, 
                merAcc: 'NNVTC2C2PVOL', 
                time: '28/01/2026 09:30',
                destAccNo: '001100998877', 
                destAccName: 'TRAN THI B',
                content: 'Chuyển tiền TRẠM SẠC HẢI PHÒNG', 
                createdTime: '28/01/2026 09:15', 
                updatedTime: '-', 
                user: '-', 
                status: 'CREATED', 
                note: 'Thông tin không hợp lệ hoặc không đầy đủ' 
            },
            { 
                id: 3, 
                orderId: '3509405', 
                transId: '2776250', 
                bankName: 'Techcombank', 
                amount: 15500000, 
                merAcc: 'NNVTC2C2PVOL', 
                time: '27/01/2026 15:45',
                destAccNo: '190333444555', 
                destAccName: 'LE VAN C',
                content: 'Chuyển tiền TRẠM SẠC LONG BIÊN', 
                createdTime: '27/01/2026 15:00', 
                updatedTime: '27/01/2026 16:00', 
                user: 'admin', 
                status: 'SUCCESS', 
                note: 'Chuyển tiền thành công' 
            },
            { 
                id: 4, 
                orderId: '3509406', 
                transId: '2776251', 
                bankName: 'BIDV', 
                amount: 8500000, 
                merAcc: 'NNVTC2C2PVOL', 
                time: '27/01/2026 10:20',
                destAccNo: '12345678', 
                destAccName: 'PHAM VAN D',
                content: 'Chuyển tiền TRẠM SẠC CẦU GIẤY', 
                createdTime: '27/01/2026 10:00', 
                updatedTime: '27/01/2026 10:30', 
                user: 'hongtt', 
                status: 'SUCCESS', 
                note: 'Đã duyệt' 
            },
            { 
                id: 5, 
                orderId: '3509407', 
                transId: '2776252', 
                bankName: 'VPBank', 
                amount: 3200000, 
                merAcc: 'NNVTC2C2PVOL', 
                time: '26/01/2026 14:00',
                destAccNo: '999888777', 
                destAccName: 'HOANG THI E',
                content: 'Chuyển tiền TRẠM SẠC THANH XUÂN', 
                createdTime: '26/01/2026 13:30', 
                updatedTime: '26/01/2026 14:15', 
                user: 'system', 
                status: 'CANCELLED', 
                note: 'Đối tác yêu cầu hủy' 
            },
            { 
                id: 6, 
                orderId: '3509408', 
                transId: '2776253', 
                bankName: 'MBBank', 
                amount: 5000000, 
                merAcc: 'NNVTC2C2PVOL', 
                time: '26/01/2026 09:45',
                destAccNo: '888899990000', 
                destAccName: 'VU VAN F',
                content: 'Chuyển tiền TRẠM SẠC ĐÀ NẴNG', 
                createdTime: '26/01/2026 09:30', 
                updatedTime: '-', 
                user: '-', 
                status: 'PENDING', 
                note: 'Đã gửi yêu cầu' 
            },
            { 
                id: 7, 
                orderId: '3509409', 
                transId: '2776254', 
                bankName: 'Sacombank', 
                amount: 120000000, 
                merAcc: 'NNVTC2C2PVOL', 
                time: '25/01/2026 11:15',
                destAccNo: '020011223344', 
                destAccName: 'NGO THI G',
                content: 'Chuyển tiền TRẠM SẠC QUẬN 7 HCM', 
                createdTime: '25/01/2026 11:00', 
                updatedTime: '25/01/2026 11:30', 
                user: 'ktt', 
                status: 'SUCCESS', 
                note: 'Chuyển tiền thành công' 
            },
            { 
                id: 8, 
                orderId: '3509410', 
                transId: '2776255', 
                bankName: 'Agribank', 
                amount: 4500000, 
                merAcc: 'NNVTC2C2PVOL', 
                time: '25/01/2026 16:20',
                destAccNo: '333344445555', 
                destAccName: 'DO VAN H',
                content: 'Chuyển tiền TRẠM SẠC CẦN THƠ', 
                createdTime: '25/01/2026 16:00', 
                updatedTime: '25/01/2026 16:30', 
                user: 'admin', 
                status: 'CANCELLED', 
                note: 'Sai thông tin tài khoản' 
            },
            { 
                id: 9, 
                orderId: '3509411', 
                transId: '2776256', 
                bankName: 'BIDV', 
                amount: 9000000, 
                merAcc: 'NNVTC2C2PVOL', 
                time: '24/01/2026 10:00',
                destAccNo: '211100009999', 
                destAccName: 'BUI THI I',
                content: 'Chuyển tiền TRẠM SẠC NHA TRANG', 
                createdTime: '24/01/2026 09:45', 
                updatedTime: '-', 
                user: '-', 
                status: 'PENDING', 
                note: 'Đã gửi yêu cầu' 
            },
            { 
                id: 10, 
                orderId: '3509412', 
                transId: '2776257', 
                bankName: 'Vietinbank', 
                amount: 6000000, 
                merAcc: 'NNVTC2C2PVOL', 
                time: '24/01/2026 15:30',
                destAccNo: '101020203030', 
                destAccName: 'DANG VAN K',
                content: 'Chuyển tiền TRẠM SẠC VŨNG TÀU', 
                createdTime: '24/01/2026 15:00', 
                updatedTime: '24/01/2026 15:45', 
                user: 'hongtt', 
                status: 'SUCCESS', 
                note: 'Đã duyệt' 
            },
            { 
                id: 11, 
                orderId: '3509413', 
                transId: '2776258', 
                bankName: 'Agribank', 
                amount: 7500000, 
                merAcc: 'NNVTC2C2PVOL', 
                time: '23/01/2026 08:30',
                destAccNo: '445566778899', 
                destAccName: 'TRINH THI L',
                content: 'Chuyển tiền TRẠM SẠC THANH TRÌ', 
                createdTime: '23/01/2026 08:00', 
                updatedTime: '23/01/2026 08:30', 
                user: 'admin', 
                status: 'SUCCESS', 
                note: 'Đối tác gửi yêu cầu' 
            }
        ];

        // --- ADDED MISSING FUNCTION ---
        function initMerchantList() {
            const datalist = document.getElementById('merchantListOptions');
            datalist.innerHTML = '';
            for (const [code, info] of Object.entries(mockMerchants)) {
                const option = document.createElement('option');
                option.value = code;
                option.label = info.name;
                datalist.appendChild(option);
            }
        }

        // --- LOGIC TAB 1: TẠO YÊU CẦU ---

        function handleMerchantInput(input) {
            const val = input.value.trim().toUpperCase();
            if (mockMerchants[val]) { checkMerchant(); } else { resetMerchantCheck(); }
        }

        function checkMerchant() {
            const mcCode = document.getElementById('merchantAccount').value.trim().toUpperCase();
            const btnCheck = document.getElementById('btnCheckMerchant');
            
            if (!mcCode) return;
            if (btnCheck.disabled) return;

            btnCheck.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btnCheck.disabled = true;

            setTimeout(() => {
                btnCheck.innerHTML = '<i class="fa-solid fa-magnifying-glass"></i>';
                btnCheck.disabled = false;

                if (mockMerchants[mcCode]) {
                    const data = mockMerchants[mcCode];
                    document.getElementById('isValidMerchant').value = "true";
                    document.getElementById('merchantAccount').classList.add('is-valid-check');
                    document.getElementById('merchantResultContainer').style.display = 'block';
                    document.getElementById('merchantNameDisplay').innerText = data.name;
                } else {
                    if (event && event.type === 'click') { showAlert("Không tìm thấy thông tin tài khoản!"); }
                    resetMerchantCheck();
                }
            }, 500);
        }

        function resetMerchantCheck() {
            document.getElementById('isValidMerchant').value = "false";
            document.getElementById('merchantAccount').classList.remove('is-valid-check');
            document.getElementById('merchantResultContainer').style.display = 'none';
        }

        function resetBenName() {
            document.getElementById('benNameDisplay').value = '';
            // If user changes bank, re-lookup only if account no exists
            if(document.getElementById('destAccountInput').value) {
                lookupBeneficiaryName();
            }
        }

        function lookupBeneficiaryName() {
            const bankName = document.getElementById('destBankInput').value;
            const accNo = document.getElementById('destAccountInput').value.trim();
            const benNameInput = document.getElementById('benNameDisplay');
            const loader = document.getElementById('benNameLoader');

            if (!bankName || !accNo) return;

            // Simulate API Call
            loader.classList.remove('d-none-custom');
            benNameInput.value = '';

            setTimeout(() => {
                loader.classList.add('d-none-custom');
                // Simple logic to simulate name generation based on input
                if (accNo.length < 6) {
                    // Invalid simulation
                    showAlert("Số tài khoản không hợp lệ (giả lập)");
                } else {
                    const mockNames = ["TRẠM SẠC HAI BÀ TRƯNG", "TRẠM SẠC HẢI PHÒNG", "TRẠM SẠC LONG BIÊN", "TRẠM SẠC CẦU GIẤY"];
                    const randomName = mockNames[Math.floor(Math.random() * mockNames.length)];
                    benNameInput.value = randomName;
                }
            }, 1000);
        }

        function formatCurrencyInput(input) {
            let rawValue = input.value.replace(/\D/g, '');
            if (rawValue === '') { input.value = ''; document.getElementById('amountInWords').innerText = ""; return; }
            input.value = new Intl.NumberFormat('vi-VN').format(rawValue);
            
            const rawVal = input.value.replace(/\./g, '');
            const amount = Number(rawVal);
            if (amount > 0) {
                const text = docSoThanhChu(amount);
                document.getElementById('amountInWords').innerText = `Bằng chữ: ${text} đồng`;
            } else {
                document.getElementById('amountInWords').innerText = "";
            }
        }

        function checkCustomReason() {
            const reason = document.getElementById('transferReason').value;
            const customArea = document.getElementById('customReasonArea');
            if (reason === 'OTHER') { customArea.classList.remove('d-none-custom'); customArea.required = true; } 
            else { customArea.classList.add('d-none-custom'); customArea.required = false; }
        }

        function resetTab1() {
            resetMerchantCheck();
            document.getElementById('amountInWords').innerText = '';
            document.getElementById('benNameDisplay').value = '';
        }

        function handleSingleTransfer(e) {
            e.preventDefault();
            const isValidMerchant = document.getElementById('isValidMerchant').value;
            if (isValidMerchant !== "true") { showAlert("Vui lòng kiểm tra thông tin tài khoản Merchant!"); return; }
            
            const benName = document.getElementById('benNameDisplay').value;
            if(!benName) { showAlert("Vui lòng đợi hệ thống xác thực tên người thụ hưởng!"); return; }

            document.getElementById('singleTransferAlert').classList.add('d-none-custom');
            
            showConfirm('Bạn có chắc chắn muốn tạo yêu cầu chi hộ này?', () => {
                // Add to approval list logic (simulation)
                const amount = document.getElementById('singleAmount').value.replace(/\./g, '');
                const now = new Date();
                const formattedTime = now.toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(',', '');
                
                const newReq = {
                    id: approvalData.length + 1,
                    orderId: '350' + Math.floor(Math.random()*10000),
                    transId: '277' + Math.floor(Math.random()*10000),
                    bankName: document.getElementById('destBankInput').value || 'Vietinbank',
                    amount: parseInt(amount),
                    merAcc: 'NNVTC2C2PVOL', // Use fixed mock
                    time: formattedTime,
                    destAccNo: document.getElementById('destAccountInput').value,
                    destAccName: benName,
                    content: document.getElementById('transferReason').value,
                    createdTime: formattedTime,
                    updatedTime: '-', user: '-', status: 'CREATED', note: 'Khởi tạo mới'
                };
                approvalData.unshift(newReq);
                renderApprovalTable(); // Refresh table in tab 2
                
                showAlert("Tạo yêu cầu thành công! Vui lòng chuyển sang tab Duyệt tiền.");
                resetTab1();
                document.getElementById('formSingleTransfer').reset();
            });
        }

        // --- LOGIC TAB 2: DUYỆT TIỀN CHI HỘ ---

        function getStatusBadge(status) {
            switch(status) {
                case 'CREATED': return '<span class="badge badge-created">Khởi tạo</span>';
                case 'PENDING': return '<span class="badge badge-pending-approval">Chờ duyệt</span>';
                case 'SUCCESS': return '<span class="badge badge-success">Thành công</span>';
                case 'CANCELLED': return '<span class="badge badge-cancelled">Đã hủy</span>';
                case 'REFUNDED': return '<span class="badge badge-refunded">Hoàn tiền</span>';
                default: return '<span class="badge bg-secondary">Unknown</span>';
            }
        }

        function getActionButtons(item) {
            if (item.status === 'CREATED' || item.status === 'PENDING') {
                return `
                    <div class="d-flex flex-wrap gap-1 justify-content-center">
                        <button class="btn btn-primary btn-sm" title="Duyệt" onclick="approveTx(${item.id})"><i class="fa-solid fa-check"></i></button>
                        <button class="btn btn-warning btn-sm" title="Hủy" onclick="cancelTx(${item.id})"><i class="fa-solid fa-ban"></i></button>
                        <button class="btn btn-danger btn-sm" title="Xóa" onclick="deleteTx(${item.id})"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
            } else if (item.status === 'CANCELLED') {
                 return `
                    <div class="d-flex flex-wrap gap-1 justify-content-center">
                        <button class="btn btn-danger btn-sm" title="Xóa" onclick="deleteTx(${item.id})"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
            } else {
                return ``; // Empty for SUCCESS as requested
            }
        }

        function renderApprovalTable() {
            const tbody = document.getElementById('approvalTableBody');
            tbody.innerHTML = '';
            
            // Filters
            const fStatus = document.getElementById('filterStatus').value;
            const fMer = document.getElementById('filterMerAcc').value.trim().toLowerCase();
            const fBank = document.getElementById('filterDestBank').value.trim().toLowerCase();
            const fBankAcc = document.getElementById('filterBankAcc').value.trim();

            const filtered = approvalData.filter(item => {
                if (fStatus && fStatus !== 'Tất cả' && item.status !== fStatus) return false;
                if (fMer && !item.merAcc.toLowerCase().includes(fMer)) return false; 
                if (fBank && !item.bankName.toLowerCase().includes(fBank)) return false;
                if (fBankAcc && !item.destAccNo.includes(fBankAcc)) return false;
                return true;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="15" class="text-center py-4 text-muted">Không có dữ liệu</td></tr>';
                return;
            }

            filtered.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="col-id">${item.orderId}</td>
                    <td>${item.transId}</td>
                    <td>${item.bankName}</td>
                    <td class="col-money">${formatMoney(item.amount)}</td>
                    <td>${item.merAcc}</td>
                    <!-- REMOVED TIME CELL -->
                    <td>${item.destAccNo}</td>
                    <td>${item.destAccName}</td>
                    <td>${item.content}</td>
                    <td class="col-date">${formatDateTime(item.createdTime)}</td>
                    <td class="col-date">${formatDateTime(item.updatedTime)}</td>
                    <td>${item.user}</td>
                    <td class="col-status">${getStatusBadge(item.status)}</td>
                    <td>${item.note}</td>
                    <td class="col-action sticky-col">${getActionButtons(item)}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Update Pagination Text
            const paginationInfo = document.getElementById('paginationInfo');
            if (paginationInfo) {
                paginationInfo.innerHTML = `Hiển thị <span class="fw-bold">1-${filtered.length}</span> trên <span class="fw-bold">${filtered.length}</span> bản ghi`;
            }
        }

        function filterTableLocal(query) {
            // Very basic Client-side text filter
            const filter = query.toUpperCase();
            const table = document.getElementById("approvalTable");
            const tr = table.getElementsByTagName("tr");
            for (let i = 1; i < tr.length; i++) {
                let txtValue = tr[i].textContent || tr[i].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }

        // --- NEW APPROVAL LOGIC WITH MODAL ---
        
        function approveTx(id) {
            const item = approvalData.find(x => x.id === id);
            if (!item) return;

            // Populate Modal Fields
            document.getElementById('modalTxId').value = item.id;
            document.getElementById('modalOrderId').value = item.orderId;
            document.getElementById('modalTransId').value = item.transId;
            document.getElementById('modalBankName').value = item.bankName;
            document.getElementById('modalAmount').value = formatMoney(item.amount);
            document.getElementById('modalMerAcc').value = item.merAcc;
            document.getElementById('modalDestAccNo').value = item.destAccNo;
            document.getElementById('modalDestAccName').value = item.destAccName;
            document.getElementById('modalContent').value = item.content;
            document.getElementById('modalCreatedTime').value = formatDateTime(item.createdTime);
            document.getElementById('modalNote').value = '';

            // Reset Channel selection
            document.getElementById('modalChannelSelect').value = "";
            document.getElementById('modalSourceAcc').value = "";
            document.getElementById('modalSourceName').value = "";

            // Show Modal
            const modal = new bootstrap.Modal(document.getElementById('approveModal'));
            modal.show();
        }

        function updateApproveSourceAccount() {
            const channel = document.getElementById('modalChannelSelect').value;
            const sourceAccInput = document.getElementById('modalSourceAcc');
            const sourceNameInput = document.getElementById('modalSourceName');

            if (channel && sourceAccounts[channel]) {
                sourceAccInput.value = sourceAccounts[channel];
                sourceNameInput.value = "Tổng công ty truyền thông đa phương tiện VTC";
            } else {
                sourceAccInput.value = "";
                sourceNameInput.value = "";
            }
        }

        function confirmApprove() {
            const id = parseInt(document.getElementById('modalTxId').value);
            const channel = document.getElementById('modalChannelSelect').value;
            const note = document.getElementById('modalNote').value;

            if (!channel) {
                showAlert("Vui lòng chọn Kênh kết nối (Ngân hàng nguồn)!");
                return;
            }

            const item = approvalData.find(x => x.id === id);
            if (item) {
                item.status = 'SUCCESS';
                const now = new Date();
                const formattedTime = now.toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(',', '');
                item.updatedTime = formattedTime;
                item.user = 'hongtt';
                item.note = note || 'Đã duyệt'; // Update note
                
                renderApprovalTable();
                
                // Close modal
                const modalEl = document.getElementById('approveModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();

                showAlert("Đã duyệt giao dịch thành công!");
            }
        }

        function cancelTx(id) {
            showConfirm("Xác nhận HỦY giao dịch này?", () => {
                const item = approvalData.find(x => x.id === id);
                if (item) {
                    item.status = 'CANCELLED';
                    const now = new Date();
                    const formattedTime = now.toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(',', '');
                    item.updatedTime = formattedTime;
                    item.user = 'hongtt';
                    item.note = 'Đối tác yêu cầu hủy'; // Update note
                    renderApprovalTable();
                    showAlert("Đã hủy giao dịch!");
                }
            });
        }

        function deleteTx(id) {
            showConfirm("Xác nhận XÓA bản ghi này?", () => {
                approvalData = approvalData.filter(x => x.id !== id);
                renderApprovalTable();
                showAlert("Đã xóa bản ghi!");
            });
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            initMerchantList();
            renderApprovalTable();
        });

    </script>
</body>
</html>
